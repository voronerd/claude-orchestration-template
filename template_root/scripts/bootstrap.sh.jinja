#!/bin/bash
# Bootstrap script for {{ project_name }}
set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$PROJECT_ROOT"

echo "=== Bootstrapping {{ project_name }} ==="
echo "Project root: $PROJECT_ROOT"

# Validate .env availability for new projects
{% if not existing_project %}
# User indicated this is a NEW project, so we need .env from template or home directory
TEMPLATE_ENV_FOUND=false
HOME_ENV_FOUND=false
PROJECT_ENV_FOUND=false

# Check project directory first (copier may have created .env from .env.template)
if [[ -f "$PROJECT_ROOT/.env" ]]; then
    PROJECT_ENV_FOUND=true
fi

# Check common template locations
if [[ -f ~/claude-orchestration-template/.env ]]; then
    TEMPLATE_ENV_FOUND=true
fi

if [[ -f ~/.env ]]; then
    HOME_ENV_FOUND=true
fi

if [[ "$PROJECT_ENV_FOUND" == "false" && "$TEMPLATE_ENV_FOUND" == "false" && "$HOME_ENV_FOUND" == "false" ]]; then
    echo ""
    echo "ERROR: No .env file found for new project setup"
    echo ""
    echo "Please create a .env file in one of these locations:"
    echo "  1. $PROJECT_ROOT/.env (project directory)"
    echo "  2. ~/claude-orchestration-template/.env"
    echo "  3. ~/.env (fallback)"
    echo ""
    echo "Your .env should contain:"
    echo "  ANTHROPIC_API_KEY=your-key-here"
{% if include_multi_model_overseer %}
    echo "  GEMINI_API_KEY=your-key-here"
    echo "  OPENAI_API_KEY=your-key-here"
{% endif %}
    echo ""
    echo "Alternatively, if you're updating an existing project,"
    echo "re-run copier and answer 'Yes' to 'Updating existing project?'"
    echo ""
    exit 1
fi
{% endif %}

# Copy or create .env in project directory if it doesn't exist
if [[ ! -f .env ]]; then
    # Try to copy from known locations (real keys take priority over template)
    if [[ -f ~/claude-orchestration-template/.env ]]; then
        cp ~/claude-orchestration-template/.env .env
        chmod 600 .env
        echo "Copied .env from ~/claude-orchestration-template/.env"
    elif [[ -f ~/.env ]]; then
        cp ~/.env .env
        chmod 600 .env
        echo "Copied .env from ~/.env"
    elif [[ -f .env.template ]]; then
        cp .env.template .env
        chmod 600 .env
        echo ""
        echo "Created .env from template"
        echo ""
        echo "IMPORTANT: Edit .env and add your API keys"
        echo "  Required: ANTHROPIC_API_KEY"
{% if include_multi_model_overseer %}
        echo "  Optional: GEMINI_API_KEY, OPENAI_API_KEY"
{% endif %}
{% if include_grok_agent %}
        echo "  Optional: GROK_API_KEY (for Grok)"
{% endif %}
{% if include_exa %}
        echo "  Optional: EXA_API_KEY (for Exa web search)"
{% endif %}
        echo ""
        echo "Run this script again after adding your keys."
        exit 1
    else
        echo "Warning: No .env file found and no .env.template to create from"
        exit 1
    fi
fi

# Validate required variables - safe parsing (no code execution)
if [ -f .env ]; then
    set -a  # automatically export all variables
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ -z "$key" || "$key" =~ ^# ]] && continue
        # Remove surrounding quotes from value
        value="${value%\"}"
        value="${value#\"}"
        value="${value%\'}"
        value="${value#\'}"
        export "$key=$value"
    done < .env
    set +a
fi

if [[ -z "$ANTHROPIC_API_KEY" || "$ANTHROPIC_API_KEY" == "your-anthropic-key-here" ]]; then
    echo ""
    echo "ERROR: ANTHROPIC_API_KEY not set in .env"
    echo "  Get your key from: https://console.anthropic.com/"
    exit 1
fi

echo "Environment configured"

# Set up .env sourcing in shell profile for MCP server env vars
# Uses safe key=value parser (NOT shell source) to prevent code execution
ENV_PATH="$(cd "$PROJECT_ROOT" && pwd)/.env"

if [[ -f "$HOME/.profile" ]] || [[ -f "$HOME/.bashrc" ]] || [[ -f "$HOME/.zshrc" ]]; then
    PROFILE_FILE="$HOME/.profile"
    if ! grep -qF "$ENV_PATH" "$PROFILE_FILE" 2>/dev/null; then
        if [[ -t 0 ]]; then
            read -p "Add API key loading to ~/.profile? [Y/n] " -n 1 -r
            echo
        else
            REPLY="y"  # Default to yes in non-interactive mode (CI, test harness)
        fi
        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            cat >> "$PROFILE_FILE" << ENVBLOCK

# Load API keys for Claude Code MCP servers (added by bootstrap)
# Safe parser: only exports KEY=VALUE lines, skips comments and empty lines
if [ -f "$ENV_PATH" ]; then
    while IFS='=' read -r _key _val; do
        case "\$_key" in
            ''|\#*) continue ;;
        esac
        case "\$_key" in
            *[!A-Za-z0-9_]*) continue ;;
        esac
        _val="\${_val%\"}"
        _val="\${_val#\"}"
        _val="\${_val%\'}"
        _val="\${_val#\'}"
        export "\$_key=\$_val"
    done < "$ENV_PATH"
fi
ENVBLOCK
            echo "Added API key loading to $PROFILE_FILE"
            echo "  (Open a new terminal for API keys to take effect)"
        else
            echo "Skipped. Manually export API keys or add to your shell profile."
        fi
    else
        echo "API key loading already configured in $PROFILE_FILE"
    fi
else
    echo "Note: No shell profile found. Export API keys manually for MCP servers."
fi

# Create state directory
mkdir -p .claude/.state
echo "Created .claude/.state directory"

# Create task directories
{% if enable_task_system %}
mkdir -p tasks/detail tasks/done
echo "Created task directories"
{% endif %}

# Make scripts executable
find scripts -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
find .claude/hooks -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
echo "Made scripts executable"

# Build MCP servers (TypeScript -> JavaScript)
echo ""
echo "Building MCP servers..."

# Function to build an MCP server
build_mcp_server() {
    local server_dir="$1"
    local server_name="$2"

    if [[ -f "$server_dir/package.json" ]]; then
        echo "  Building $server_name..."
        (
            cd "$server_dir"
            npm ci --ignore-scripts 2>&1 || npm install --ignore-scripts 2>&1
            npx tsc 2>&1
        )

        if [[ -f "$server_dir/dist/index.js" ]]; then
            echo "    ✓ $server_name built successfully"
        else
            echo "    ⚠ $server_name build failed (API key may be missing - can retry later)"
        fi
    fi
}

# Build each MCP server independently (failures are non-fatal)
{% if include_multi_model_overseer %}
build_mcp_server "mcp-servers/openai-mcp" "openai-mcp"
{% if include_grok_agent %}
build_mcp_server "mcp-servers/grok-mcp" "grok-mcp"
{% endif %}
{% endif %}
{% if has_reasoning_model %}
build_mcp_server "mcp-servers/reasoning-mcp" "reasoning-mcp"
{% endif %}
{% if has_model_router %}
build_mcp_server "mcp-servers/model-router-mcp" "model-router-mcp"
{% endif %}

# Install pre-commit hooks
{% if include_pre_commit %}
if command -v pre-commit &> /dev/null; then
    echo "Installing pre-commit hooks..."
    pre-commit install

    # Create secrets baseline if it doesn't exist
    if [[ ! -f .secrets.baseline ]]; then
        echo "Creating secrets baseline..."
        detect-secrets scan --baseline .secrets.baseline 2>/dev/null || true
    fi
else
    echo "Warning: pre-commit not installed. Run: pip install pre-commit"
fi
{% endif %}

# Initialize git if not already
if [[ ! -d .git ]]; then
    echo ""
    echo "Git not initialized. Run:"
    echo "  git init"
    echo "  git add ."
    echo "  git commit -m 'Initial project setup'"
fi

# Offer to install cc alias
if ! command -v cc &> /dev/null && ! alias cc &> /dev/null 2>&1; then
    if ! grep -q "alias cc=" ~/.bashrc ~/.zshrc ~/.bash_aliases 2>/dev/null; then
        echo ""
        if [[ -t 0 ]]; then
            read -p "Install 'cc' alias for 'claude'? [Y/n] " -n 1 -r
            echo
        else
            REPLY="y"  # Default to yes in non-interactive mode
        fi
        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            ./scripts/install-alias.sh
        fi
    fi
fi

echo ""
echo "=== Bootstrap Complete ==="
echo ""
echo "Next steps:"
echo "1. Verify your .env has correct API keys"
echo "2. Run 'cc' (or 'claude') to start Claude Code"
echo "3. Say '/onboard' for interactive project setup"
